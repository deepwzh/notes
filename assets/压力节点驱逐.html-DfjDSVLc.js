import{_ as a,c as i,a as o,o as l}from"./app-Bc_6jXrS.js";const p="/wiki/%E4%BA%91%E5%8E%9F%E7%94%9F/K8s/static/CztmbHsS2oETvhxgjHGcF7JgnBd.png",s="/wiki/%E4%BA%91%E5%8E%9F%E7%94%9F/K8s/static/LunTb0Iqlo48Rtx7dMEcQmtDnte.png",t="/wiki/%E4%BA%91%E5%8E%9F%E7%94%9F/K8s/static/FoMabg44qo4wagxrvmvcH8l9ncb.png",c="/wiki/%E4%BA%91%E5%8E%9F%E7%94%9F/K8s/static/V0AHbqqvuo0eP2xEg55cELmun0c.png",n="/wiki/%E4%BA%91%E5%8E%9F%E7%94%9F/K8s/static/HAQfbrFW9o0LB5x3JrhcgqbJn05.jpg",d={};function r(h,e){return l(),i("div",null,e[0]||(e[0]=[o('<h1 id="压力节点驱逐" tabindex="-1"><a class="header-anchor" href="#压力节点驱逐"><span>压力节点驱逐</span></a></h1><h1 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h1><p>k8s node 上有一组参数，控制 k8s 中的内存，磁盘等资源占用占全部资源的最大比例，超过这个比例，pod 可能会被驱逐(evicted)</p><p>关于驱逐有以下几个概念</p><p>有三个概念：</p><ul><li><p>驱逐信号</p></li><li><p>驱逐条件</p><ul><li>软驱逐条件</li><li>硬驱逐条件</li></ul></li><li><p>节点条件</p></li></ul><p>这些概念之间的关系是：</p><ul><li>节点条件 = f(驱逐条件)，当满足不同的驱逐条件，节点条件会被设置成不同的值</li><li>驱逐条件 = 驱逐信号 关系运算符（&lt;,=,&gt;） 条件值</li></ul><h1 id="驱逐信号" tabindex="-1"><a class="header-anchor" href="#驱逐信号"><span>驱逐信号</span></a></h1><p><img src="'+p+'" alt=""></p><p>注意其中的 nodefs 和 imagefs 区别：</p><ol><li><p><code>nodefs</code>：</p><ol><li>节点的主要文件系统，用于本地磁盘卷、emptyDir、日志存储等。 例如，<code>nodefs</code> 包含 <code>/var/lib/kubelet/</code>。</li><li>默认就是/var/lib/kubelet 所在的分区，可以通过 kubelet 参数--root-dir 指定</li></ol></li><li><p><code>imagefs</code>：</p><ol><li>可选文件系统，供容器运行时存储容器镜像和容器可写层。</li><li>就是 docker 所在的分区</li></ol></li></ol><h1 id="驱逐条件" tabindex="-1"><a class="header-anchor" href="#驱逐条件"><span>驱逐条件</span></a></h1><p>驱逐条件公式： 驱逐信号 关系运算符（&lt;,=,&gt;） 条件值</p><p>分为软驱逐条件和硬驱逐条件。</p><p>区别是一个有宽限期一个没有宽限期</p><p>软驱逐条件相关配置(kubelet 配置中指定)：</p><ul><li><code>eviction-soft</code>：一组驱逐条件，如 <code>memory.available&lt;1.5Gi</code>， 如果驱逐条件持续时长超过指定的宽限期，可以触发 Pod 驱逐。</li><li><code>eviction-soft-grace-period</code>：一组驱逐宽限期， 如 <code>memory.available=1m30s</code>，定义软驱逐条件在触发 Pod 驱逐之前必须保持多长时间。</li><li><code>eviction-max-pod-grace-period</code>：在满足软驱逐条件而终止 Pod 时使用的最大允许宽限期（以秒为单位）</li></ul><blockquote><p>eviction-soft 默认值为 nil，即不设置软驱逐条件，具体见文档</p></blockquote><p>硬驱逐条件相关配置(kubelet 配置中指定)</p><ul><li>eviction-hard</li></ul><blockquote><p>默认值: memory.available: &quot;100Mi&quot; nodefs.available: &quot;10%&quot; nodefs.inodesFree: &quot;5%&quot; imagefs.available: &quot;15%&quot;</p></blockquote><p>两组配置默认值详见参考文档 2</p><h1 id="节点条件" tabindex="-1"><a class="header-anchor" href="#节点条件"><span>节点条件</span></a></h1><p>当某 pod 满足了驱逐条件，会反映在 node 的节点条件上</p><p>可以根据这个信息去判断驱逐的原因</p><p><img src="'+s+'" alt=""></p><h1 id="某机器某-pod-驱逐事件分析" tabindex="-1"><a class="header-anchor" href="#某机器某-pod-驱逐事件分析"><span>某机器某 pod 驱逐事件分析</span></a></h1><h2 id="分析过程" tabindex="-1"><a class="header-anchor" href="#分析过程"><span>分析过程</span></a></h2><p>首先发现某服务执行会长时间卡住不动，去 k8s 平台查看 pod 状态</p><p><img src="'+t+'" alt=""></p><p>发现处于驱逐状态</p><p>驱逐的原因可能为磁盘，pid，内存不够，要具体确认的话需要看下节点事件中的条件状态</p><p><img src="'+c+'" alt=""></p><p>发现是 DiskPressure，查阅官网文档得知，可能是 nodefs 或者 imagefs 到达了阈值</p><p>登上机器 df 看一下</p><p><img src="'+n+'" alt=""></p><p>根目录分区到达 85%,目前配置中 nodefs 与 imagefs 均在根目录，驱逐条件没用手动设置过，默认值分别为 5% 和 15%，即已到达驱逐条件</p><h2 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案"><span>解决方案</span></a></h2><p>根分区中删点文件</p><h1 id="" tabindex="-1"><a class="header-anchor" href="#"><span></span></a></h1><p>参考资料</p>',42)]))}const u=a(d,[["render",r]]),E=JSON.parse('{"path":"/%E4%BA%91%E5%8E%9F%E7%94%9F/K8s/%E5%8E%8B%E5%8A%9B%E8%8A%82%E7%82%B9%E9%A9%B1%E9%80%90.html","title":"压力节点驱逐","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"分析过程","slug":"分析过程","link":"#分析过程","children":[]},{"level":2,"title":"解决方案","slug":"解决方案","link":"#解决方案","children":[]}],"git":{},"filePathRelative":"云原生/K8s/压力节点驱逐.md"}');export{u as comp,E as data};
